<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>도시락 배달 관리 시스템</title>
  <style>
    /* ===== 기본 ===== */
    :root{
      --primary:#2176ff;
      --primary-ink:#1c3f6e;
      --ink:#222;
      --soft:#f6f8fa;
      --shadow:0 6px 24px #0001;
    }
    *{box-sizing:border-box}
    body { font-family:'Pretendard',Arial,sans-serif; margin:0; background:#f6f8fa; color:var(--ink); }
    .hscroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-min-700{ min-width:700px; } .table-min-900{ min-width:900px; } .table-min-1100{ min-width:1100px; }

    .header { background:var(--primary); color:#fff; padding:20px 16px 14px; font-size:clamp(20px, 2.6vw, 28px); font-weight:700; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .top-btns { display:flex; gap:8px; flex-wrap:wrap; }
    .top-btns button { border:none; border-radius:8px; background:#fffde7; color:var(--primary); padding:8px 12px; font-weight:700; cursor:pointer; font-size:14px; box-shadow:0 0 2px #bbb; touch-action:manipulation; }

    .nav { margin-top:12px; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; padding:0 8px; }
    .nav button { display:inline-block; background:#f5f8fe; border:none; color:var(--primary); padding:10px 16px; margin:0 6px 0 0; font-size:15px; font-weight:700; border-radius:10px 10px 0 0; cursor:pointer; transition:background .2s; touch-action:manipulation; }
    .nav button.active, .nav button:hover { background:#fff; border-bottom:2px solid var(--primary); }
    .page { display:none; } .page.active { display:block; }

    /* 백업 재연결 배너 */
    .backup-banner{
      display:none; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 14px; background:#fff3cd; color:#7a5d00;
      border:1px solid #ffe08a; border-radius:10px; max-width:1050px;
      margin:10px auto 0; box-shadow:0 1px 4px #0001;
    }
    .backup-banner.show{ display:flex; flex-wrap:wrap; }
    .backup-banner .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .backup-banner button{ border:none; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:800; touch-action:manipulation; }
    .backup-banner .primary{ background:#1976d2; color:#fff; }
    .backup-banner .ghost{ background:#fff; color:#7a5d00; border:1px solid #ffe08a; }

    /* ===== 배달 카드 ===== */
    .delivery-card { display:inline-block; background:#f6fafd; border-radius:14px; box-shadow:0 1px 6px #0001; margin:8px 12px 8px 0; padding:13px 30px 11px 20px; min-width:110px; }
    .delivery-card .card-title { font-size:18px; font-weight:600; margin-bottom:5px; }
    .delivery-card .card-prod { font-size:16px; }
    .customer-detail-card { display:inline-block; margin:8px 10px 8px 0; border-radius:14px; padding:13px 25px 13px 19px; min-width:120px; box-shadow:0 1px 6px #0002; }
    .customer-detail-card .card-title { font-size:17px; font-weight:600; margin-bottom:6px; }
    .customer-detail-card .card-prod { font-size:15px; }

    /* ===== 달력(메인) ===== */
    .calendar-container { background:#fff; margin:28px auto 0; max-width:900px; border-radius:18px; padding:20px; box-shadow:var(--shadow); }
    .calendar-header-area { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom:12px; }
    .calendar-header-area select, .calendar-header-area button { font-size:16px; padding:8px 10px; border:1px solid #a4c6ff; border-radius:10px; background:#f2f8ff; color:var(--primary-ink); font-weight:700; cursor:pointer; }
    .calendar-header-area button { background:#e3f2fd; border:1px solid #b2d6ff; color:var(--primary); }
    .calendar-header-area button:hover { background:#d0ebff; }
    .calendar-table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .calendar-table th { height:40px; background:var(--primary); color:#fff; font-size:16px; border-radius:8px 8px 0 0; }
    .calendar-table th.sunday { color:#ffe0e0 !important; background:#d32f2f !important; }
    .calendar-table td { width:90px; height:72px; border:1.5px solid #d6e6ff; text-align:right; vertical-align:top; background:#fff; position:relative; border-radius:8px; cursor:pointer; font-size:18px; padding:6px 8px 4px 0; transition:background .15s; }
    .calendar-table td.today { border:2.5px solid var(--primary); background:#e3f0ff; }
    .calendar-table td.holiday { background:#ffe5e1 !important; color:#c33728; font-weight:bold; }
    .calendar-table td.sunday { color:#e53935; }
    .calendar-table td .memo { display:block; position:absolute; left:4px; bottom:4px; right:4px; font-size:12px; background:#ffd54f; color:#7d5000; border-radius:6px; padding:1px 5px; text-align:left; font-weight:700; }
    .calendar-table td:hover { background:#e3f2fd; }

    /* 월 매출 요약 */
    .calendar-monthly-total { max-width:900px; margin:10px auto 0; background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:flex-end; color:#1a237e; flex-wrap:wrap; }
    .calendar-monthly-total .title{ margin-right:auto; font-weight:900; color:#2153a0; }
    .calendar-monthly-total .pill{ background:#f0f5ff; border:1px solid #d7e4ff; border-radius:999px; padding:6px 10px; font-weight:800; }

    .holidays-lists-area { margin:14px auto 0; max-width:900px; display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .holidays-list-card { background:#f6f8fa; border-radius:14px; box-shadow:0 2px 10px #0001; padding:14px 16px 16px; }
    .holidays-list-card h4 { margin:0 0 8px; font-size:16px; color:#1976d2; }
    .holidays-list-card li { list-style:none; padding:6px 0; font-size:14px; border-bottom:1px dotted #e1e4e8; color:#1a237e; display:flex; justify-content:space-between; cursor:pointer; transition:background .18s; }
    .holidays-list-card li:hover { background:#ffe08244; }

    /* ===== 고객관리 ===== */
    .customer-container { margin:24px auto 0; max-width:1000px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:20px; }
    .customer-controls { margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .customer-controls button { background:var(--primary); color:#fff; border:none; font-size:15px; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; transition:background .15s; touch-action:manipulation; }
    .customer-controls button:hover { background:#1565c0; }
    .customer-controls .print-invoice { background:#ffd36c; color:#6d4a00; }
    .customer-table { width:100%; border-collapse:collapse; background:#f7f9fc; }
    .customer-table th, .customer-table td { border:1px solid #e2e7ed; padding:10px 8px; text-align:left; font-size:15px; }
    .customer-table th { background:#e3f2fd; color:#2153a0; font-weight:800; }
    .customer-table input[type=checkbox] { width:18px; height:18px; }

    /* ===== 제품 ===== */
    .product-container { margin:24px auto 0; max-width:1200px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:20px; }
    .product-title { font-size:20px; font-weight:900; margin-bottom:10px; }
    .product-table { width:100%; border-collapse:separate; border-spacing:0; background:#f7f9fc; }
    .product-table th, .product-table td { border:1px solid #e2e7ed; padding:10px 8px; font-size:15px; text-align:left; }
    .product-table th { background:#e3f2fd; color:#2153a0; font-weight:800; }
    .prod-row input[type=text], .prod-row input[type=number] { padding:8px 8px; border-radius:8px; border:1px solid #d1dce8; font-size:15px; }
    .prod-row input[type=number] { width:90px; }
    .prod-items { display:flex; flex-wrap:wrap; gap:6px; }
    .prod-item-box { display:flex; align-items:center; background:#fff; border:1px solid #ffd1d1; border-radius:10px; padding:6px 8px; }
    .prod-item-box input[type=text]{ width:80px; } .prod-item-box input[type=number]{ width:60px; }
    .prod-item-box .prod-item-del{ background:#ffeaea; color:#b71c1c; border:none; border-radius:8px; margin-left:6px; cursor:pointer; font-size:16px; }
    .prod-add-item, .prod-add-row { background:var(--primary); color:#fff; border:none; border-radius:10px; padding:7px 12px; font-size:14px; cursor:pointer; }
    .product-table td .prod-del { background:#ffcccc; color:#b71c1c; border:none; border-radius:10px; padding:6px 12px; font-size:14px; cursor:pointer; }
    .product-table td:last-child, .product-table th:last-child { text-align:center; }

    /* ===== 모달 공통 (크기 조절 가능) ===== */
    .modal-bg, .invoice-modal-bg { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:#2228; z-index:1001; align-items:center; justify-content:center; }
    .modal-bg.active, .invoice-modal-bg.active { display:flex; }
    .modal, .invoice-modal {
      width:min(730px, 96vw); background:#fff; border-radius:16px; box-shadow:0 6px 36px #0004; padding:20px; position:relative; animation:popup .25s;
      max-height:94vh; overflow:auto;
      resize: both; min-width:320px; min-height:300px; /* 크기 조절 가능 */
    }
    .invoice-modal { width:min(980px, 98vw); }
    @keyframes popup { from{ transform:translateY(40px) scale(.97); opacity:0 } to{ transform:none; opacity:1 } }
    .modal-close, .invoice-modal-close { position:absolute; top:10px; right:12px; font-size:26px; cursor:pointer; color:#1976d2; background:none; border:none; }

    .modal-title { font-size:20px; font-weight:900; margin-bottom:12px; }
    .modal-row { margin-bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .modal-row label { min-width:58px; font-size:14px; }
    .modal-row input[type=text], .modal-row textarea { padding:8px 10px; border:1px solid #c3d5fa; border-radius:10px; font-size:14px; background:#fff; }
    .modal-row textarea { min-height:40px; width:220px; resize:vertical; }
    .toggle-btn { display:inline-block; width:68px; height:32px; background:#e4e8ef; border-radius:20px; position:relative; cursor:pointer; }
    .toggle-btn .circle { width:28px; height:28px; border-radius:50%; background:#fff; position:absolute; top:2px; left:2px; box-shadow:0 2px 8px #0001; transition:left .16s; }
    .toggle-btn.active { background:var(--primary); } .toggle-btn.active .circle{ left:38px; }
    .toggle-btn .text { position:absolute; top:5px; left:10px; font-size:13px; color:#666; }
    .toggle-btn.active .text { left:38px; color:#fff; }
    .toggle-btn.pay{ width:68px; } .toggle-btn.pay .circle{ left:2px; } .toggle-btn.pay.active .circle{ left:38px; }

    /* 미니 달력 */
    .mini-cal-wrap { background:#f7faff; border-radius:12px; padding:12px; margin-bottom:16px; }
    .mini-cal-controls { display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-bottom:6px; }
    .mini-cal-controls select, .mini-cal-controls button { font-size:14px; padding:6px 10px; border-radius:8px; border:1px solid #a4c6ff; background:#fff; color:#2153a0; }
    .mini-cal-controls button { background:#e3f2fd; font-weight:700; cursor:pointer; }
    .mini-cal-table { width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed; }
    .mini-cal-table th { background:#2176ff; color:#fff; height:30px; font-weight:700; }
    .mini-cal-table th.sunday { color:#ffe0e0 !important; background:#d32f2f !important; }
    .mini-cal-table td { border:1px solid #d6e6ff; width:45px; height:45px; background:#fff; vertical-align:top; text-align:left; padding:2px 3px 2px 4px; font-size:13px; border-radius:6px; position:relative; cursor:pointer; transition:background .1s; }
    .mini-cal-table td.selected { border:2.5px solid #1976d2; background:#e3f0ff; }
    .mini-cal-table td.today { border:2.5px solid #2176ff; background:#e9f2ff; }
    .mini-cal-table td.holiday { background:#ffe5e1 !important; color:#c33728; font-weight:bold; }
    .mini-cal-table td .memo { font-size:12px; color:#b36c00; background:#ffd54f; border-radius:3px; padding:0 2px; position:absolute; bottom:2px; left:2px; }
    .mini-cal-table td .prod-list{ margin-top:2px; } .mini-cal-table td .prod{ font-size:12px; color:#1976d2; display:block; }

    .modal-colors { display:flex; gap:8px; margin-left:2px; flex-wrap:wrap; }
    .color-circle { width:30px; height:30px; border-radius:50%; border:2px solid #bdbdbd; cursor:pointer; background:#eee; transition:border .1s; }
    .color-circle.selected { border:3px solid #1976d2; }

    .prod-control-row { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom:8px; }
    .prod-btns { margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px; }
    .weekday-checkboxes { display:none; margin-left:4px; background:#f6fafd; border-radius:10px; padding:8px 10px; }
    .prod-list-wrap { margin-bottom:8px; }
    .prod-list { padding-left:0; margin:0; }
    .prod-list li { font-size:14px; color:#1976d2; background:#f7fafd; margin-bottom:4px; padding:6px 8px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .prod-list .prod-del-btn { color:#c00; background:#fff; border:1px solid #f2c2c2; border-radius:8px; font-weight:800; font-size:14px; cursor:pointer; padding:2px 8px; }

    .total-summary { background:#f6fafd; border-radius:10px; padding:10px 14px; margin-top:10px; }
    .total-summary th, .total-summary td { padding:6px 10px; font-size:14px; } .total-summary th { background:#e7f3fe; border-radius:7px; } .total-summary td { text-align:right; }

    /* ===== 청구서 팝업 ===== */
    .invoice-info-box { background:#fff; border:1px solid #e5eaf6; border-radius:14px; padding:12px; margin-bottom:12px; }
    .invoice-info-title { font-weight:900; color:#2153a0; margin-bottom:6px; }
    .invoice-info-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px 14px; }
    .invoice-info-grid input, .invoice-info-grid textarea { width:100%; padding:8px 10px; border:1px solid #cfe; border-radius:10px; background:#f8fbff; font-size:14px; }
    .invoice-info-grid textarea { resize:vertical; min-height:48px; grid-column:1 / span 2; }

    .invoice-toolbar { display:flex; justify-content:flex-end; gap:8px; margin:6px 0 12px; flex-wrap:wrap; }
    .invoice-toolbar button { background:#1976d2; color:#fff; border:none; border-radius:10px; padding:9px 12px; font-size:14px; font-weight:800; cursor:pointer; }
    .invoice-toolbar button.secondary { background:#455a64; }
    .invoice-toolbar button.warning { background:#ff8f00; }

    .invoice-popup-cust { margin-bottom:20px; border:1px solid #e5eaf6; border-radius:14px; padding:12px; background:#fff; }
    .invoice-popup-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .invoice-popup-title { font-size:18px; font-weight:900; }
    .invoice-popup-meta { font-size:13px; color:#667; }

    .invoice-popup-datebox { display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .invoice-popup-datebox select { padding:6px 10px; border:1px solid #cfe; border-radius:10px; background:#f8fbff; }

    .invoice-grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    .invoice-cal { border:1px solid #e1e6f4; border-radius:12px; overflow:hidden; }
    .invoice-cal-title { background:#f0f5ff; padding:8px 10px; font-weight:800; font-size:14px; border-bottom:1px solid #e1e6f4; display:flex; justify-content:space-between; align-items:center; }
    .badge-paid { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#e8f5e9; color:#2e7d32; border:1px solid #cde7d1; }

    .invoice-cal-table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .invoice-cal-table th { background:#f7f9ff; font-size:12px; padding:6px 0; border-bottom:1px solid #e1e6f4; }
    .invoice-cal-table th.sunday { color:#c33; }
    .invoice-cal-table td { height:110px; border:1px solid #e1e6f4; vertical-align:top; padding:0; position:relative; background:#fff; overflow:hidden; }
    .invoice-cal-table td .dnum { position:absolute; top:4px; right:6px; font-size:12px; color:#666; font-weight:800; }
    .invoice-cal-table td .dlines { position:absolute; left:6px; right:6px; top:22px; bottom:4px; overflow:auto; }
    .invoice-cal-table td .ditem { display:block; font-size:11px; color:#1b418a; margin-top:2px; word-break:keep-all; }
    .invoice-cal-table td.holiday { background:#fff6f5; color:#c33; }

    .invoice-ledger{ border:1px solid #e1e6f4; border-radius:12px; background:#fff; }
    .invoice-ledger h5{ margin:0; padding:10px 12px; background:#f0f5ff; border-bottom:1px solid #e1e6f4; font-size:14px; color:#1b418a; }
    .invoice-ledger table{ width:100%; border-collapse:collapse; }
    .invoice-ledger th,.invoice-ledger td{ border:1px solid #e1e6f4; padding:6px 8px; font-size:13px; text-align:right; }
    .invoice-ledger th:first-child,.invoice-ledger td:first-child{ text-align:left; }
    .invoice-ledger tfoot td{ font-weight:800; }

    .info-card { border:1px solid #d9e4ff; background:#f7faff; border-radius:12px; padding:10px 12px; margin-top:10px; }
    .info-card .line { font-size:13px; padding:2px 0; }

    /* ===== 식단표 ===== */
    .meal-container{ max-width:1200px; margin:20px auto 12px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:16px; }
    .meal-header h3{ margin:0; font-size:20px; }
    .meal-toolbar{ display:flex; align-items:center; gap:8px; margin:10px 0; flex-wrap:wrap; }
    .meal-toolbar button, .meal-toolbar input[type=date]{ border:1px solid #cfe; background:#f8fbff; color:#1b418a; padding:8px 10px; border-radius:10px; font-size:14px; touch-action:manipulation; }
    .meal-toolbar button.primary{ background:#1976d2; color:#fff; border-color:#1976d2; }
    .meal-range{ font-size:14px; color:#666; margin-left:6px; }
    .meal-table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .meal-table th{ background:#edf3ff; color:#244a9a; padding:12px 8px; border:1px solid #e2e7f2; font-weight:900; text-align:center; font-size:16px; }
    .meal-table td{ border:1px solid #e2e7f2; min-height:84px; height:94px; vertical-align:middle; padding:8px; font-size:18px; background:#fff; text-align:center; }
    .meal-table td .cell-text{ white-space:pre-line; line-height:1.4; color:#183b86; font-size:18px; font-weight:800; text-align:center; }
    .meal-table .col-group{ width:190px; font-weight:900; background:#fff7f7; }
    .meal-table .group-head{ display:flex; align-items:center; justify-content:center; gap:6px; }
    .group-name{ cursor:pointer; display:block; text-align:center; }

    /* 메모 영역: 가운데 정렬 */
    .meal-note-wrap{ max-width:1200px; margin:10px auto 24px; display:flex; justify-content:center; }
    .meal-note-input{
      width:min(820px, 92vw); padding:10px 12px; border:1px solid #cfe; border-radius:10px; background:#fff;
      font-size:14px;
    }

    .meal-warehouse{ max-width:1200px; margin:10px auto 24px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px; }
    .warehouse-title{ font-weight:900; color:#1b418a; margin-bottom:8px; text-align:left; }
    .warehouse-columns{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .wh-col{ background:#f6fbff; border:1px solid #d6e9ff; border-radius:12px; padding:10px; }
    .wh-col-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    .wh-col-head .name{ font-weight:900; color:#1b418a; }
    .wh-col .wh-add{ display:flex; gap:8px; margin:8px 0; }
    .wh-col .wh-add input{ flex:1; padding:8px 10px; border:1px solid #cfe; border-radius:10px; }
    .wh-col .wh-add button{ padding:8px 10px; border-radius:10px; border:1px solid #1976d2; background:#1976d2; color:#fff; font-weight:900; cursor:pointer; }
    .wh-row{ background:#fff; border:1px solid #e5efff; border-radius:10px; padding:8px; margin-bottom:8px; }
    .wh-row .wh-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; font-size:13px; color:#445; }
    .wh-row .wh-body{ display:flex; gap:8px; align-items:center; }
    .wh-row input[type=text]{ flex:1; padding:8px 10px; border:1px solid #cfe; border-radius:10px; background:#fff; }
    .wh-del{ color:#b71c1c; background:#ffeaea; border:none; border-radius:8px; padding:6px 8px; cursor:pointer; }

    /* 식단 셀 선택 팝업 */
    .picker{ position:absolute; z-index:2000; background:#fff; border:1px solid #d7e2ff; border-radius:12px; box-shadow:0 8px 24px #0002; padding:10px; width:min(420px, 92vw); }
    .picker h5{ margin:0 0 6px; font-size:14px; color:#1b418a; }
    .picker .pick-list{ max-height:230px; overflow:auto; border:1px solid #eef3ff; padding:6px; border-radius:8px; }
    .pick-item{ display:block; padding:8px 10px; border:1px solid #dfe7ff; border-radius:8px; margin:4px 0; cursor:pointer; background:#fff; }
    .pick-item:hover{ background:#edf3ff; border-color:#bcd3ff; }
    .picker .quick{ margin-top:8px; display:flex; gap:6px; }
    .picker .quick input{ flex:1; padding:8px 10px; border:1px solid #cfe; border-radius:10px; }
    .picker .quick button{ padding:8px 12px; border-radius:10px; border:1px solid #1976d2; background:#1976d2; color:#fff; font-weight:900; cursor:pointer; width:110px; }
    .picker .clear-btn{ margin-top:8px; width:100%; border:1px solid #d9534f; background:#d9534f; color:#fff; font-weight:900; border-radius:10px; padding:8px 10px; cursor:pointer; }

    /* 토스트 */
    .toast { position:fixed; right:12px; bottom:12px; background:#323232; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:3000; opacity:0; transform:translateY(10px); transition:opacity .2s, transform .2s; }
    .toast.show { opacity:1; transform:translateY(0); }

    /* 반응형 */
    @media (max-width:1080px){ .invoice-grid { grid-template-columns:1fr; } }
    @media (max-width:1024px){
      .calendar-table td { height:56px; font-size:16px; }
      .calendar-container { padding:14px; }
      .customer-container, .product-container, .meal-container, .meal-warehouse { padding:14px; }
      .picker{ width:94vw; }
    }
    @media (max-width:768px){
      .delivery-card{ padding:10px 16px; }
      .customer-detail-card{ padding:10px 14px; }
      .invoice-cal-table td{ height:92px; }
      .meal-table th{ font-size:14px; padding:10px 6px; }
      .meal-table td{ height:86px; font-size:16px; }
      .meal-table td .cell-text{ font-size:16px; }
      .calendar-monthly-total{ justify-content:flex-start; }
    }

    /* 인쇄(고객 단위 1장) */
    @media print {
      .invoice-info-box, .invoice-toolbar, .invoice-popup-meta, .invoice-modal-bg, .modal-bg, .nav, .top-btns, .header, .backup-banner { display:none !important; }
      .invoice-popup-cust{
        page-break-after: always; break-after: page; page-break-inside: avoid; break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    도시락 배달 관리 시스템
    <div class="top-btns">
      <button id="btnBackupAssign">백업 파일 지정</button>
      <!-- 불러오기 버튼 제거 -->
    </div>
  </div>

  <!-- 백업 재연결 배너 -->
  <div id="backupReconnect" class="backup-banner">
    <div>지난 세션에 자동 백업을 사용했습니다. <b>백업 파일을 다시 지정</b>해주세요.</div>
    <div class="actions">
      <button id="backupReconnectBtn" class="primary">백업 파일 다시 지정</button>
      <button id="backupReconnectClose" class="ghost">닫기</button>
    </div>
  </div>

  <!-- Nav -->
  <div class="nav">
    <button id="tab-delivery" class="active" onclick="showPage('delivery')">배달/달력</button>
    <button id="tab-customer" onclick="showPage('customer')">고객관리</button>
    <button id="tab-product" onclick="showPage('product')">제품 관리</button>
    <button id="tab-menu" onclick="showPage('menu')">식단표</button>
  </div>

  <!-- ===== 배달 + 달력 ===== -->
  <div class="page active" id="page-delivery">
    <div style="max-width:1050px;margin:20px auto 0;background:#fff;box-shadow:0 4px 18px #0001;border-radius:18px;padding:16px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
        <span id="delivery-date" style="font-size:18px;font-weight:800;">-</span>
        <button onclick="printDelivery()" style="font-size:14px;background:#e3f2fd;border:1px solid #b2d6ff;color:#2176ff;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer;">인쇄</button>
      </div>
      <div class="hscroll">
        <div id="deliverySummaryCards" style="margin-bottom:8px; min-width:720px;"></div>
      </div>
      <div class="hscroll">
        <div id="deliveryCustomerCards" style="margin-bottom:8px; min-width:720px;"></div>
      </div>
    </div>

    <div class="calendar-container">
      <div class="calendar-header-area">
        <button onclick="changeMonth(-1)">&lt;</button>
        <select id="yearSelect"></select>
        <select id="monthSelect"></select>
        <button onclick="changeMonth(1)">&gt;</button>
        <button onclick="goToday()" style="margin-left:6px;">오늘</button>
      </div>
      <div class="hscroll">
        <table class="calendar-table table-min-700" id="calendarTable"></table>
      </div>
    </div>

    <div id="calendarMonthlyTotal" class="calendar-monthly-total"></div>

    <div class="holidays-lists-area" id="holidaysListsArea"></div>
  </div>

  <!-- ===== 고객관리 ===== -->
  <div class="page" id="page-customer">
    <div class="customer-container">
      <div style="font-size:19px;font-weight:900;margin-bottom:8px;">고객관리</div>
      <div class="customer-controls">
        <button onclick="addCustomer()">신규고객 추가</button>
        <button class="print-invoice" onclick="openInvoicePopup()">청구서 인쇄</button>
        <button style="background:#ff6666;">선택 고객 삭제</button>
      </div>
      <div class="hscroll">
        <table class="customer-table table-min-900">
          <thead>
            <tr>
              <th><input type="checkbox" id="customerSelectAll" /></th>
              <th>이름</th><th>주소</th><th>전화번호</th><th>전월까지 미수 금액</th><th>설정</th>
            </tr>
          </thead>
          <tbody id="customerTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== 제품관리 ===== -->
  <div class="page" id="page-product">
    <div class="product-container">
      <div class="product-title">제품 관리</div>
      <div class="hscroll">
        <table class="product-table table-min-1100" id="productTable">
          <thead><tr><th>#</th><th>제품명</th><th>품목(구성)</th><th>가격(원)</th><th>삭제</th></tr></thead>
          <tbody id="productTableBody"></tbody>
        </table>
      </div>
      <button class="prod-add-row" onclick="addProductRow()">+ 제품 추가</button>
    </div>
  </div>

  <!-- ===== 식단표 ===== -->
  <div class="page" id="page-menu">
    <div class="meal-container">
      <div class="meal-header"><h3>주간 식단표</h3></div>
      <div class="meal-toolbar">
        <button onclick="shiftWeek(-7)">◀ 지난 주</button>
        <button onclick="goMealToday()">오늘</button>
        <button onclick="shiftWeek(7)">▶ 다음 주</button>
        <input type="date" id="mealStartDate" />
        <span class="meal-range" id="mealRangeText"></span>
        <button class="primary" onclick="printMeal()">인쇄</button>
        <button onclick="addMealGroup()">+ 구분 추가</button>
      </div>
      <div class="hscroll">
        <table class="meal-table table-min-1100" id="mealTable"></table>
      </div>
    </div>

    <!-- 메모: 가운데 정렬 -->
    <div class="meal-note-wrap">
      <input id="mealNoteInput" class="meal-note-input" type="text" placeholder="(메모) 식단표 하단에 한 줄 메모를 남길 수 있습니다." />
    </div>

    <div class="meal-warehouse">
      <div class="warehouse-title">메뉴 창고 (구분별)</div>
      <div class="warehouse-columns" id="warehouseColumns"></div>
    </div>
  </div>

  <!-- ===== 고객설정 모달 ===== -->
  <div class="modal-bg" id="customerModalBg">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">✕</button>
      <div class="modal-title" id="modalTitle">고객 설정</div>

      <div class="modal-row">
        <label>이름</label><input type="text" id="modalName" style="width:150px;" />
        <label>주소</label><input type="text" id="modalAddr" style="width:220px;" />
      </div>
      <div class="modal-row">
        <label>전화번호</label><input type="text" id="modalPhone" style="width:150px;" />
        <label>메모</label><textarea id="modalMemo" style="width:200px;"></textarea>
      </div>

      <div class="modal-row">
        <label>행 배경색</label><div class="modal-colors" id="colorPickers"></div>
        <label style="margin-left:10px;">VAT</label>
        <div class="toggle-btn" id="vat-toggle" onclick="toggleVat()"><div class="circle"></div><div class="text">적용</div></div>
        <label style="margin-left:10px;">결제</label>
        <div class="toggle-btn pay" id="pay-toggle" onclick="togglePay()"><div class="circle"></div><div class="text">미납</div></div>
      </div>

      <div class="mini-cal-wrap">
        <div class="mini-cal-controls">
          <button onclick="miniCalMonth(-1)">&lt;</button>
          <select id="miniCalYear"></select>
          <select id="miniCalMonth"></select>
          <button onclick="miniCalMonth(1)">&gt;</button>
        </div>
        <table class="mini-cal-table" id="miniCalTable"></table>
      </div>

      <div class="prod-control-row">
        <label>제품</label><select id="prodNameSel"></select>
        <label>수량</label><input type="number" id="prodQty" value="1" min="1" max="10" />
        <label>금액</label><input type="number" id="prodPrice" value="0" min="0" style="width:110px;" />
      </div>
      <div class="prod-btns">
        <button onclick="changeProdToDate('only')">이날만 변경</button>
        <button onclick="removeProdFromDate('only')">이날만 중지</button>
        <button onclick="showWeekdaySelection()">이날부터 변경</button>
        <button onclick="removeProdFromDate('after')">이날부터 중지</button>
      </div>

      <div class="weekday-checkboxes" id="weekdayCheckArea">
        <label><input type="checkbox" value="1" />월</label>
        <label><input type="checkbox" value="2" />화</label>
        <label><input type="checkbox" value="3" />수</label>
        <label><input type="checkbox" value="4" />목</label>
        <label><input type="checkbox" value="5" />금</label>
        <label><input type="checkbox" value="6" />토</label>
        <label><input type="checkbox" value="0" />일</label>
        <label><input type="checkbox" value="H" />공휴일</label>
        <button onclick="changeProdToDate('after',true)" style="margin-left:6px;">적용</button>
        <button onclick="hideWeekdaySelection()" style="margin-left:3px;">닫기</button>
      </div>

      <div class="prod-list-wrap"><ul class="prod-list" id="prodListUl"></ul></div>
      <div class="total-summary" id="summaryBox"></div>

      <div style="text-align:right;margin-top:12px;">
        <button onclick="saveModalSchedule()" style="background:#388e3c;color:#fff;border:none;border-radius:10px;font-size:16px;padding:10px 18px;font-weight:900;cursor:pointer;">저장</button>
      </div>
    </div>
  </div>

  <!-- ===== 청구서 인쇄 팝업 ===== -->
  <div class="invoice-modal-bg" id="invoiceModalBg">
    <div class="invoice-modal" id="invoiceModal">
      <button class="invoice-modal-close" onclick="closeInvoicePopup()">✕</button>

      <div class="invoice-toolbar">
        <button onclick="printInvoicePopup()">인쇄</button>
        <button class="secondary" onclick="saveInvoiceAsJPG()">파일로 저장(JPG)</button>
        <button class="warning" onclick="filterInvoiceThisMonth()">이번달 고객만</button>
      </div>

      <div class="invoice-info-box">
        <div class="invoice-info-title">청구정보</div>
        <div class="invoice-info-grid">
          <div><input id="invInfoCompany" type="text" placeholder="상호명" /></div>
          <div><input id="invInfoPerson" type="text" placeholder="담당자 (예: 홍길동 010-0000-0000)" /></div>
          <div><input id="invInfoAccount" type="text" placeholder="계좌번호 (예: 국민 000000-00-000000 예금주)" /></div>
          <div><input id="invInfoDate" type="text" placeholder="작성일 (예: 2025-08-10)" /></div>
          <div style="grid-column:1 / span 2;"><textarea id="invInfoNote" placeholder="비고"></textarea></div>
        </div>
      </div>

      <div id="invoicePopupArea"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ===== 자바스크립트 (모든 기능 포함) ===== -->
  <script>
    /* ===== 유틸 ===== */
    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymd(y,m,d){ return y+'-'+pad2(m)+'-'+pad2(d); }
    function parseDateStr(s){ var p=s.split('-'); return new Date(+p[0], +p[1]-1, +p[2]); }
    function getTomorrowStr(){ var d=new Date(); d.setDate(d.getDate()+1); return ymd(d.getFullYear(), d.getMonth()+1, d.getDate()); }
    function showToast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>el.classList.remove('show'), 2500); }

    var WEEK_LABELS=['일','월','화','수','목','금','토'];
    var today=new Date(), currentYear=today.getFullYear(), currentMonth=today.getMonth();
    var selectedDeliveryDate=getTomorrowStr();

    /* ===== 데이터 ===== */
    var holidays={
      "2025-08-15":"광복절","2025-10-03":"개천절","2025-10-06":"추석",
      "2025-10-07":"추석","2025-10-08":"추석","2025-10-09":"한글날","2025-12-25":"크리스마스"
    };
    var customers=[
      {name:"자연숲아파트", addr:"(남양) 강변1길 33-19", phone:"010-2214-0940", memo:"", bgColor:"#ffebee", vatSep:true, schedule:{}, paidMap:{}, lastModalYm:""},
      {name:"화이트홀 라브", addr:"(남양) 강변1길 22-30", phone:"010-2312-6604", memo:"", bgColor:"#e3f2fd", vatSep:true, schedule:{}, paidMap:{}, lastModalYm:""}
    ];
    var productList=[
      {name:"보은", items:[{name:"보은", qty:1}], price:6000},
      {name:"뷔페", items:[{name:"뷔페", qty:1}], price:6000},
      {name:"알뜰 2인", items:[{name:"국", qty:2},{name:"전골", qty:1},{name:"반찬", qty:2}], price:11000}
    ];

    /* ===== 페이지 전환 ===== */
    function showPage(page){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById('page-'+page).classList.add('active');
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById('tab-'+page).classList.add('active');
      if(page==='delivery'){ renderDeliveryPage(); renderCalendar(); renderHolidaysList(); }
      if(page==='customer'){ renderCustomerTable(); }
      if(page==='product'){ renderProductTable(); }
      if(page==='menu'){ renderMeal(); renderWarehouseColumns(); }
    }

    /* ===== 배달물량 ===== */
    function setDeliveryDateFromCalendar(dateStr){ selectedDeliveryDate=dateStr; renderDeliveryPage(); }
    function renderDeliveryPage(){
      var d=parseDateStr(selectedDeliveryDate);
      document.getElementById('delivery-date').textContent =
        `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${WEEK_LABELS[d.getDay()]})`;

      var itemSum={}, customerCardHTML='';
      customers.forEach(c=>{
        var bg=c.bgColor||'#fff';
        var prods=(c.schedule[selectedDeliveryDate]||[]);
        if(!prods.length) return;
        var card=`<div class="customer-detail-card" style="background:${bg};"><div class="card-title">${c.name}</div>`;
        prods.forEach(prod=>{
          var pinfo=productList.find(x=>x.name===prod.name);
          if(pinfo){ pinfo.items.forEach(item=>{ itemSum[item.name]=(itemSum[item.name]||0)+item.qty*prod.qty; }); }
          card += `<div class="card-prod">${prod.name} ×${prod.qty}</div>`;
        });
        card += `</div>`; customerCardHTML += card;
      });

      var itemCardsHTML='';
      Object.keys(itemSum).forEach(item=>{
        itemCardsHTML += `<div class="delivery-card"><div class="card-title">${item}</div>
          <div class="card-prod">${itemSum[item]} 개</div></div>`;
      });

      document.getElementById('deliverySummaryCards').innerHTML=itemCardsHTML;
      document.getElementById('deliveryCustomerCards').innerHTML=customerCardHTML;
    }

    /* 인쇄(배경색 포함) */
    function printDelivery() {
      const d = parseDateStr(selectedDeliveryDate);
      const head = `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${WEEK_LABELS[d.getDay()]})`;

      const itemSum = {};
      let customerCardHTML = '';

      customers.forEach(cust => {
        const list = (cust.schedule[selectedDeliveryDate] || []);
        if (!list.length) return;
        const bg = cust.bgColor || '#fff';

        list.forEach(prod => {
          const pinfo = productList.find(x => x.name === prod.name);
          if (pinfo) pinfo.items.forEach(item => itemSum[item.name]=(itemSum[item.name]||0)+item.qty*prod.qty);
        });

        let lines = '';
        list.forEach(prod => { lines += `<div class="card-prod">${prod.name} ×${prod.qty}</div>`; });

        customerCardHTML += `
          <div class="customer-detail-card" style="background-color:${bg}; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
            <div class="card-title">${cust.name}</div>${lines}
          </div>`;
      });

      let itemCardsHTML = '';
      Object.keys(itemSum).forEach(item => {
        itemCardsHTML += `<div class="delivery-card"><div class="card-title">${item}</div><div class="card-prod">${itemSum[item]} 개</div></div>`;
      });

      const page = `<div style="font-size:22px;font-weight:800;margin-bottom:10px;">${head}</div><div>${itemCardsHTML}</div><div style="margin-top:8px;">${customerCardHTML}</div>`;
      const css = `<style>
        *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body{background:#fff !important; font-family:Pretendard,Arial,sans-serif; color:#222;}
        .delivery-card{display:inline-block;background:#f6fafd;border-radius:14px;box-shadow:0 1px 6px #0001;margin:8px 12px 8px 0;padding:13px 30px 11px 20px;min-width:110px;}
        .delivery-card .card-title{font-size:18px;font-weight:700;margin-bottom:5px;}
        .delivery-card .card-prod{font-size:16px;}
        .customer-detail-card{display:inline-block;margin:8px 10px 8px 0;border-radius:14px;padding:13px 25px 13px 19px;min-width:120px;box-shadow:0 1px 6px #0002;}
        .customer-detail-card .card-title{font-size:17px;font-weight:800;margin-bottom:6px;}
        .customer-detail-card .card-prod{font-size:15px;}
      </style>`;
      const win = window.open('', '', 'width=1000,height=800');
      win.document.write('<html><head><title>배달물량 인쇄</title>' + css + '</head><body>' + page + '</body></html>');
      win.document.close();
      setTimeout(() => win.print(), 400);
    }

    /* ===== 달력 ===== */
    function fillYearMonth(){
      const ySel=document.getElementById('yearSelect'), mSel=document.getElementById('monthSelect');
      ySel.innerHTML=''; mSel.innerHTML='';
      for(let y=today.getFullYear()-2;y<=today.getFullYear()+10;y++){ let o=document.createElement('option'); o.value=y; o.textContent=y+'년'; ySel.appendChild(o); }
      for(let m=0;m<12;m++){ let o=document.createElement('option'); o.value=m; o.textContent=(m+1)+'월'; mSel.appendChild(o); }
      ySel.value=currentYear; mSel.value=currentMonth;
      ySel.onchange=()=>{ currentYear=parseInt(ySel.value,10); renderCalendar(); };
      mSel.onchange=()=>{ currentMonth=parseInt(mSel.value,10); renderCalendar(); };
    }
    function goToday(){
      today=new Date(); currentYear=today.getFullYear(); currentMonth=today.getMonth();
      document.getElementById('yearSelect').value=currentYear;
      document.getElementById('monthSelect').value=currentMonth;
      renderCalendar();
      selectedDeliveryDate=getTomorrowStr(); renderDeliveryPage();
    }
    function changeMonth(diff){
      currentMonth+=diff; if(currentMonth<0){currentMonth=11; currentYear--;} if(currentMonth>11){currentMonth=0; currentYear++;}
      document.getElementById('yearSelect').value=currentYear;
      document.getElementById('monthSelect').value=currentMonth;
      renderCalendar();
    }
    function handleCalendarDateClick(dateStr){
      const now=new Date(); const thisDate=parseDateStr(dateStr);
      if(holidays[dateStr]){
        const del=confirm(`${dateStr}\n"${holidays[dateStr]}" 공휴일을 삭제할까요?\n\n[확인] 삭제, [취소] 배달물량 날짜로 보기`);
        if(del){ delete holidays[dateStr]; renderCalendar(); renderHolidaysList(); return; }
        setDeliveryDateFromCalendar(dateStr); return;
      }else{
        if(thisDate < new Date(now.getFullYear(), now.getMonth(), now.getDate())){
          setDeliveryDateFromCalendar(dateStr); return;
        }
        const memo=prompt(`${dateStr}\n공휴일명을 입력하세요 (예: 추석, 설날 등)\n(취소하면 공휴일 미등록, 배달물량 날짜로 설정됩니다)`);
        if(memo && memo.trim()){
          holidays[dateStr]=memo.trim();
          renderCalendar(); renderHolidaysList();
          applyHolidayRetroactively(dateStr);
          return;
        }
        setDeliveryDateFromCalendar(dateStr); return;
      }
    }
    function computeMonthlySales(y, m){
      let supply=0, vat=0;
      customers.forEach(c=>{
        let prodSum=0;
        const prefix = y+'-'+pad2(m)+'-';
        for(const d in (c.schedule||{})){
          if(d.startsWith(prefix)){
            (c.schedule[d]||[]).forEach(it=>{ prodSum += (it.qty||0)*(it.price||0); });
          }
        }
        supply += prodSum;
        if(c.vatSep) vat += Math.round(prodSum * 0.1);
      });
      return { supply, vat, total: supply + vat };
    }
    function renderCalendarMonthlyTotal(){
      const box=document.getElementById('calendarMonthlyTotal');
      const s=computeMonthlySales(currentYear, currentMonth+1);
      box.innerHTML = `
        <div class="title">${currentYear}년 ${currentMonth+1}월 매출</div>
        <div class="pill">공급가: ${s.supply.toLocaleString()}원</div>
        <div class="pill">VAT: ${s.vat.toLocaleString()}원</div>
        <div class="pill"><b>합계: ${s.total.toLocaleString()}원</b></div>`;
    }
    function renderCalendar(){
      const cal=document.getElementById('calendarTable'); cal.innerHTML='';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      WEEK_LABELS.forEach((d,i)=>{ const th=document.createElement('th'); th.textContent=d; if(i===0) th.className='sunday'; trh.appendChild(th); });
      thead.appendChild(trh); cal.appendChild(thead);

      const tbody=document.createElement('tbody');
      const firstDate=new Date(currentYear, currentMonth, 1);
      const lastDate=new Date(currentYear, currentMonth+1, 0);
      let row=document.createElement('tr');
      for(let i=0;i<firstDate.getDay();i++) row.appendChild(document.createElement('td'));

      for(let d=1; d<=lastDate.getDate(); d++){
        if(row.children.length===7){ tbody.appendChild(row); row=document.createElement('tr'); }
        const td=document.createElement('td'); const ds=ymd(currentYear, currentMonth+1, d);
        td.textContent=d;
        if((row.children.length)%7===0) td.classList.add('sunday');
        if(currentYear===today.getFullYear() && currentMonth===today.getMonth() && d===today.getDate()) td.classList.add('today');
        if(holidays[ds]){ td.classList.add('holiday'); const memo=document.createElement('span'); memo.className='memo'; memo.textContent=holidays[ds]; td.appendChild(memo); }
        td.onclick=()=>handleCalendarDateClick(ds);
        row.appendChild(td);
      }
      while(row.children.length<7) row.appendChild(document.createElement('td'));
      tbody.appendChild(row); cal.appendChild(tbody);

      renderCalendarMonthlyTotal();
    }
    function renderHolidaysList(){
      const area=document.getElementById('holidaysListsArea'); area.innerHTML='';
      const yearMap={}, now=new Date();
      Object.keys(holidays).forEach(dt=>{
        const hdate=parseDateStr(dt);
        if(hdate >= new Date(now.getFullYear(), now.getMonth(), now.getDate())){
          const y=dt.slice(0,4); if(!yearMap[y]) yearMap[y]=[]; yearMap[y].push({date:dt, memo:holidays[dt]});
        }
      });
      Object.keys(yearMap).sort().forEach(y=>{
        const card=document.createElement('div'); card.className='holidays-list-card';
        card.innerHTML=`<h4>${y}년</h4>`;
        const ul=document.createElement('ul');
        yearMap[y].sort((a,b)=>a.date.localeCompare(b.date))
          .forEach(item=>{
            const li=document.createElement('li'); li.innerHTML=`<span>${item.date.slice(5)}</span><span>${item.memo}</span>`;
            li.onclick=()=>{
              currentYear=parseInt(item.date.slice(0,4),10); currentMonth=parseInt(item.date.slice(5,7),10)-1;
              document.getElementById('yearSelect').value=currentYear;
              document.getElementById('monthSelect').value=currentMonth;
              renderCalendar();
            };
            ul.appendChild(li);
          });
        card.appendChild(ul); area.appendChild(card);
      });
    }

    /* ===== 고객 테이블 ===== */
    function renderCustomerTable(){
      const tb=document.getElementById('customerTableBody'); tb.innerHTML='';
      const now=new Date(); const ym=now.getFullYear()+'-'+pad2(now.getMonth()+1);
      customers.forEach((c,i)=>{
        const unpaid=getPrevUnpaid(c, ym);
        const tr=document.createElement('tr'); tr.style.background=c.bgColor||'#fff';
        tr.innerHTML = `
          <td><input type="checkbox" class="customerCheck" data-index="${i}" /></td>
          <td>${c.name}</td><td>${c.addr}</td><td>${c.phone}</td>
          <td>${unpaid.toLocaleString()}원</td>
          <td><button onclick="openModal(${i})">설정</button></td>`;
        tb.appendChild(tr);
      });
      const all=document.getElementById('customerSelectAll');
      if(all){ all.onchange=()=>{ document.querySelectorAll('.customerCheck').forEach(cb=>cb.checked=all.checked); }; }
    }
    function getMonthTotal(customer, ym){
      let prodSum=0;
      for(let date in (customer.schedule||{})){
        if(date.startsWith(ym+'-')) (customer.schedule[date]||[]).forEach(it=>{ prodSum += it.qty*(it.price||0); });
      }
      const vat = customer.vatSep ? Math.round(prodSum*0.1) : 0;
      const total = prodSum + vat;
      if(customer.paidMap && customer.paidMap[ym]) return 0;
      return total;
    }
    function getPrevUnpaid(customer, ym){
      let [y,m]=ym.split('-').map(v=>parseInt(v,10));
      let total=0;
      for(let i=0;i<24;i++){
        m-=1; if(m<=0){y--; m=12;}
        const ym2 = y+'-'+pad2(m);
        const paidThis = getMonthTotal(customer, ym2);
        if(paidThis===0) break;
        total += paidThis;
      }
      return total;
    }
    function addCustomer(){
      customers.push({name:"",addr:"",phone:"",memo:"",bgColor:"#fffde7",vatSep:true,schedule:{},paidMap:{},lastModalYm:""});
      renderCustomerTable(); openModal(customers.length-1);
    }

    /* ===== 제품관리 ===== */
    function renderProductTable(){
      const tbody=document.getElementById('productTableBody'); tbody.innerHTML='';
      productList.forEach((row,i)=>{
        const tr=document.createElement('tr'); tr.className='prod-row';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td><input type="text" value="${row.name}" onchange="productList[${i}].name=this.value;renderProductTable();fillProdOptions();" /></td>
          <td><div class="prod-items" id="prodItems-${i}"></div><button class="prod-add-item" onclick="addProdItem(${i})">+ 품목</button></td>
          <td><input type="number" value="${row.price}" onchange="productList[${i}].price=parseInt(this.value)||0" /></td>
          <td><button class="prod-del" onclick="delProductRow(${i})">삭제</button></td>`;
        tbody.appendChild(tr); renderProdItems(i);
      });
    }
    function renderProdItems(idx){
      const div=document.getElementById('prodItems-'+idx); div.innerHTML='';
      productList[idx].items.forEach((item,j)=>{
        const box=document.createElement('div'); box.className='prod-item-box';
        box.innerHTML = `
          <input type="text" value="${item.name}" onchange="productList[${idx}].items[${j}].name=this.value" />
          <span>&times;</span>
          <input type="number" value="${item.qty}" min="1" onchange="productList[${idx}].items[${j}].qty=parseInt(this.value)||1" />
          <button class="prod-item-del" onclick="delProdItem(${idx},${j})">×</button>`;
        div.appendChild(box);
      });
    }
    function addProductRow(){ productList.push({name:"",items:[{name:"",qty:1}],price:0}); renderProductTable(); fillProdOptions(); }
    function delProductRow(i){ if(confirm('이 제품을 삭제하시겠습니까?')){ productList.splice(i,1); renderProductTable(); fillProdOptions(); } }
    function addProdItem(i){ productList[i].items.push({name:"",qty:1}); renderProdItems(i); }
    function delProdItem(i,j){ if(productList[i].items.length>1){ productList[i].items.splice(j,1); renderProdItems(i); } }
    function fillProdOptions(){
      const sel=document.getElementById('prodNameSel'); if(!sel) return; sel.innerHTML='';
      productList.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; sel.appendChild(opt); });
      sel.onchange=function(){ const prod=productList.find(x=>x.name===sel.value); document.getElementById('prodPrice').value = prod?prod.price:0; };
      const prod=productList.find(x=>x.name===sel.value); document.getElementById('prodPrice').value = prod?prod.price:0;
    }

    /* ===== 고객설정 모달 ===== */
    let tempCustIdx, tempData={}, tempSchedule={}, tempVatSep=true, tempPaid=false, tempPaidMap={};
    let miniCalYearVal=today.getFullYear(), miniCalMonthVal=today.getMonth(), selectedDate=null;
    function currentYmKey(){ return miniCalYearVal+'-'+pad2(miniCalMonthVal+1); }
    function syncPaidToggleToCurrentMonth(){ tempPaid = !!tempPaidMap[currentYmKey()]; updatePayToggle(); }

    function openModal(idx){
      tempCustIdx=idx; const c=customers[idx];
      tempData={...c};
      tempSchedule=JSON.parse(JSON.stringify(c.schedule||{}));
      tempVatSep=(c.vatSep!==false);
      tempPaidMap=JSON.parse(JSON.stringify(c.paidMap||{}));

      if(c.lastModalYm && /^\d{4}-\d{2}$/.test(c.lastModalYm)){ const [yy,mm]=c.lastModalYm.split('-').map(x=>parseInt(x,10)); miniCalYearVal=yy; miniCalMonthVal=mm-1; }
      else { miniCalYearVal=today.getFullYear(); miniCalMonthVal=today.getMonth(); }

      tempPaid=!!tempPaidMap[currentYmKey()];

      document.getElementById('modalName').value=c.name||'';
      document.getElementById('modalAddr').value=c.addr||'';
      document.getElementById('modalPhone').value=c.phone||'';
      document.getElementById('modalMemo').value=c.memo||'';

      const colors=document.getElementById('colorPickers'); colors.innerHTML='';
      const colorList = ['#ffebee','#fff3e0','#fffde7','#e8f5e9','#e3f2fd','#e8eaf6','#f3e5f5']; /* 7색 */
      colorList.forEach(col=>{
        const cdiv=document.createElement('div'); cdiv.className='color-circle'; cdiv.style.background=col;
        if((tempData.bgColor||'#ffebee')===col) cdiv.classList.add('selected');
        cdiv.onclick=function(){
          document.querySelectorAll('.color-circle').forEach(x=>x.classList.remove('selected'));
          cdiv.classList.add('selected');
          tempData.bgColor=col;
          const row=document.querySelectorAll('#customerTableBody tr')[tempCustIdx]; if(row) row.style.background=col;
        };
        colors.appendChild(cdiv);
      });

      updateVatToggle(); updatePayToggle();
      fillMiniCalYM(); renderMiniCal(); fillProdOptions(); renderProdList(); renderSummary(); hideWeekdaySelection();
      document.getElementById('customerModalBg').classList.add('active');
    }
    function closeModal(){ document.getElementById('customerModalBg').classList.remove('active'); }
    function toggleVat(){ tempVatSep=!tempVatSep; updateVatToggle(); renderMiniCal(); renderProdList(); renderSummary(); }
    function updateVatToggle(){ const t=document.getElementById('vat-toggle'); t.className='toggle-btn'+(tempVatSep?' active':''); t.querySelector('.text').textContent=(tempVatSep?'적용':'미적용'); }
    function togglePay(){
      tempPaid=!tempPaid; tempPaidMap[currentYmKey()] = tempPaid ? true : false;
      customers[tempCustIdx].paidMap = JSON.parse(JSON.stringify(tempPaidMap));
      customers[tempCustIdx].lastModalYm = currentYmKey();
      updatePayToggle(); renderCustomerTable();
    }
    function updatePayToggle(){ const t=document.getElementById('pay-toggle'); t.className='toggle-btn pay'+(tempPaid?' active':''); t.querySelector('.text').textContent=(tempPaid?'완납':'미납'); }

    function fillMiniCalYM(){
      const ySel=document.getElementById('miniCalYear'), mSel=document.getElementById('miniCalMonth');
      ySel.innerHTML=''; mSel.innerHTML='';
      for(let y=today.getFullYear()-1; y<=today.getFullYear()+10; y++){ const o=document.createElement('option'); o.value=y; o.textContent=y+'년'; ySel.appendChild(o); }
      for(let m=0;m<12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=(m+1)+'월'; mSel.appendChild(o); }
      ySel.value=miniCalYearVal; mSel.value=miniCalMonthVal;

      const apply=()=>{ customers[tempCustIdx].lastModalYm=currentYmKey(); syncPaidToggleToCurrentMonth(); renderMiniCal(); renderSummary(); };
      ySel.onchange=()=>{ miniCalYearVal=parseInt(ySel.value,10); apply(); };
      mSel.onchange=()=>{ miniCalMonthVal=parseInt(mSel.value,10); apply(); };
      syncPaidToggleToCurrentMonth();
    }
    function miniCalMonth(diff){
      miniCalMonthVal+=diff; if(miniCalMonthVal<0){miniCalYearVal--; miniCalMonthVal=11;} if(miniCalMonthVal>11){miniCalYearVal++; miniCalMonthVal=0;}
      customers[tempCustIdx].lastModalYm=currentYmKey();
      syncPaidToggleToCurrentMonth();
      fillMiniCalYM(); renderMiniCal(); renderSummary();
    }
    function renderMiniCal(){
      const t=document.getElementById('miniCalTable'); t.innerHTML='';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      WEEK_LABELS.forEach((d,i)=>{ const th=document.createElement('th'); th.textContent=d; if(i===0) th.className='sunday'; trh.appendChild(th); });
      thead.appendChild(trh); t.appendChild(thead);

      const tbody=document.createElement('tbody');
      const firstDate=new Date(miniCalYearVal, miniCalMonthVal, 1);
      const lastDate=new Date(miniCalYearVal, miniCalMonthVal+1, 0);
      let row=document.createElement('tr'); for(let i=0;i<firstDate.getDay();i++) row.appendChild(document.createElement('td'));

      const ymdToday=ymd(today.getFullYear(), today.getMonth()+1, today.getDate());
      for(let d=1; d<=lastDate.getDate(); d++){
        if(row.children.length===7){ tbody.appendChild(row); row=document.createElement('tr'); }
        const td=document.createElement('td'); const ds=ymd(miniCalYearVal, miniCalMonthVal+1, d);
        td.textContent=d; if((row.children.length)%7===0) td.classList.add('sunday');
        if(holidays[ds]){ td.classList.add('holiday'); const memo=document.createElement('span'); memo.className='memo'; memo.textContent=holidays[ds]; td.appendChild(memo); }
        if(ds===ymdToday) td.classList.add('today');

        const list=tempSchedule[ds]||[];
        if(list.length){
          const plist=document.createElement('div'); plist.className='prod-list';
          list.forEach(prod=>{
            const unit=prod.price||0; const unitDisp=tempVatSep?Math.round(unit*1.1):unit;
            const sp=document.createElement('span'); sp.className='prod'; sp.textContent=`${prod.name} ×${prod.qty} (${unitDisp.toLocaleString()}원)`;
            plist.appendChild(sp);
          });
          td.appendChild(plist);
        }
        if(selectedDate===ds) td.classList.add('selected');
        td.onclick=()=>{ selectedDate=ds; renderMiniCal(); renderProdList(); };
        row.appendChild(td);
      }
      while(row.children.length<7) row.appendChild(document.createElement('td'));
      tbody.appendChild(row); t.appendChild(tbody);
    }
    function showWeekdaySelection(){ document.getElementById('weekdayCheckArea').style.display='inline-block'; }
    function hideWeekdaySelection(){ document.getElementById('weekdayCheckArea').style.display='none'; }

    /* 공휴일 소급 적용 */
    function applyHolidayRetroactively(ds){
      customers.forEach(c=>{
        if(!c.schedule || !c.schedule[ds]) return;
        const newList = (c.schedule[ds]||[]).filter(it=> !(it._rule && it._rule.type==='weekdayAfter' && it._rule.includeHoliday===false));
        if(newList.length) c.schedule[ds]=newList; else delete c.schedule[ds];
      });
      if(tempSchedule && tempSchedule[ds]){
        const newList = (tempSchedule[ds]||[]).filter(it=> !(it._rule && it._rule.type==='weekdayAfter' && it._rule.includeHoliday===false));
        if(newList.length) tempSchedule[ds]=newList; else delete tempSchedule[ds];
        renderMiniCal(); renderProdList(); renderSummary();
      }
      renderDeliveryPage(); renderCustomerTable(); renderCalendar();
    }

    function changeProdToDate(type, useWeekdays){
      if(!selectedDate) return alert('날짜를 선택하세요.');
      const name=document.getElementById('prodNameSel').value;
      const qty=parseInt(document.getElementById('prodQty').value,10)||1;
      const price=parseInt(document.getElementById('prodPrice').value,10)||0;
      if(!name||!qty) return alert('제품/수량을 입력하세요');

      if(type==='only'){
        if(!tempSchedule[selectedDate]) tempSchedule[selectedDate]=[];
        tempSchedule[selectedDate].push({name,qty,price});
      }else if(type==='after' && useWeekdays){
        const checked=[...document.querySelectorAll('#weekdayCheckArea input:checked')].map(e=>e.value);
        if(!checked.length) return alert('요일을 1개 이상 선택!');
        const incHoliday = checked.includes('H');
        const selDay=parseInt(selectedDate.slice(-2),10);
        const baseY=miniCalYearVal, baseM=miniCalMonthVal;
        const monthsAhead=12;

        for(let mo=0; mo<monthsAhead; mo++){
          const dateTmp=new Date(baseY, baseM+mo, 1);
          const y=dateTmp.getFullYear(), m=dateTmp.getMonth();
          const days=new Date(y, m+1, 0).getDate();
          const startDay = (mo===0 ? selDay : 1);
          for(let d=startDay; d<=days; d++){
            const ds=ymd(y, m+1, d);
            const wd=new Date(y, m, d).getDay();
            const isHoliday=!!holidays[ds];
            let insert=false;
            checked.forEach(val=>{ if((val==='H'&&isHoliday) || (val!=='H'&&wd===parseInt(val,10))) insert=true; });
            if(isHoliday && !incHoliday) continue;
            if(insert){
              if(!tempSchedule[ds]) tempSchedule[ds]=[];
              tempSchedule[ds].push({name,qty,price, _rule:{type:'weekdayAfter', includeHoliday:incHoliday}});
            }
          }
        }
        hideWeekdaySelection();
      }
      renderMiniCal(); renderProdList(); renderSummary();
    }
    function removeProdFromDate(type){
      if(!selectedDate) return alert('날짜를 선택하세요.');
      if(type==='only'){ delete tempSchedule[selectedDate]; }
      else if(type==='after'){
        const y=miniCalYearVal, m=miniCalMonthVal, start=parseInt(selectedDate.slice(-2),10), days=new Date(y, m+1, 0).getDate();
        for(let d=start; d<=days; d++){ const ds=ymd(y, m+1, d); delete tempSchedule[ds]; }
      }
      renderMiniCal(); renderProdList(); renderSummary();
    }
    function renderProdList(){
      const ul=document.getElementById('prodListUl'); ul.innerHTML='';
      if(!selectedDate || !tempSchedule[selectedDate]) return;
      tempSchedule[selectedDate].forEach((prod,idx)=>{
        const unit=prod.price||0, unitDisp=tempVatSep?Math.round(unit*1.1):unit;
        const li=document.createElement('li');
        li.innerHTML = `<span>${prod.name} ×${prod.qty} (${unitDisp.toLocaleString()}원)</span>`;
        const btn=document.createElement('button'); btn.textContent='삭제'; btn.className='prod-del-btn';
        btn.onclick=()=>{ tempSchedule[selectedDate].splice(idx,1); if(!tempSchedule[selectedDate].length) delete tempSchedule[selectedDate]; renderMiniCal(); renderProdList(); renderSummary(); };
        li.appendChild(btn); ul.appendChild(li);
      });
    }
    function renderSummary(){
      const box=document.getElementById('summaryBox'); let y=miniCalYearVal, m=miniCalMonthVal+1; const prefix=y+'-'+pad2(m)+'-';
      let prodSum=0; for(let k in tempSchedule){ if(k.startsWith(prefix)) tempSchedule[k].forEach(it=>{ prodSum += it.qty*(it.price||0); }); }
      const vat=tempVatSep?Math.round(prodSum*0.1):0, total=prodSum+vat;
      box.innerHTML = `<table>
        <tr><th>소계</th><td style="text-align:right">${prodSum.toLocaleString()}원</td></tr>
        <tr><th>VAT</th><td style="text-align:right">${vat.toLocaleString()}원</td></tr>
        <tr><th>총액</th><td style="text-align:right"><b>${total.toLocaleString()}원</b></td></tr>
      </table>`;
    }
    function saveModalSchedule(){
      const i=tempCustIdx, c=customers[i];
      c.name=document.getElementById('modalName').value;
      c.addr=document.getElementById('modalAddr').value;
      c.phone=document.getElementById('modalPhone').value;
      c.memo=document.getElementById('modalMemo').value;
      c.bgColor=tempData.bgColor||'#ffebee';
      c.vatSep=tempVatSep;
      c.paidMap=JSON.parse(JSON.stringify(tempPaidMap));
      c.lastModalYm=currentYmKey();
      c.schedule=JSON.parse(JSON.stringify(tempSchedule));
      renderCustomerTable(); renderCalendar(); renderDeliveryPage();
      closeModal();
    }

    /* ===== 청구서 팝업 ===== */
    function openInvoicePopup(){
      const checked=[...document.querySelectorAll('.customerCheck:checked')];
      if(!checked.length){ alert('인쇄할 고객을 선택하세요!'); return; }
      const area=document.getElementById('invoicePopupArea'); area.innerHTML='';

      checked.forEach(cb=>{
        const idx=parseInt(cb.getAttribute('data-index'),10), cust=customers[idx];
        const now=new Date(); let yy=now.getFullYear(), mm=now.getMonth()+1;

        const yearSelId='invoiceYear_'+idx, monthSelId='invoiceMonth_'+idx;
        const calWrapId='invoiceCal_'+idx, sumWrapId='invoiceSum_'+idx;

        const renderCal=(y,m)=>{
          const first=new Date(y, m-1, 1), last=new Date(y, m, 0);
          const paidThisMonth=!!(cust.paidMap && cust.paidMap[y+'-'+pad2(m)]);
          let html=`<div class="invoice-cal"><div class="invoice-cal-title"><span>${y}년 ${m}월</span>${paidThisMonth?'<span class="badge-paid">완납</span>':''}</div>
            <table class="invoice-cal-table"><thead><tr>`;
          WEEK_LABELS.forEach((w,i)=>{ html+=`<th class="${i===0?'sunday':''}">${w}</th>`; });
          html+=`</tr></thead><tbody>`;
          let dayOfWeek=first.getDay(), col=0; html+='<tr>'; for(let i=0;i<dayOfWeek;i++){ html+='<td></td>'; col++; }
          const prefix=y+'-'+pad2(m)+'-';
          for(let d=1; d<=last.getDate(); d++){
            if(col===7){ html+='</tr><tr>'; col=0; }
            const ds=prefix+pad2(d); const cls=(holidays[ds]?' holiday':'');
            const list=(cust.schedule[ds]||[]);
            let lines='';
            list.forEach(p=>{
              const line=(p.qty||0)*(p.price||0);
              lines += `<span class="ditem">${p.name}×${p.qty} (${line.toLocaleString()}원)</span>`;
            });
            html+=`<td class="${cls}"><span class="dnum">${d}</span><div class="dlines">${lines}</div></td>`;
            col++;
          }
          while(col<7){ html+='<td></td>'; col++; }
          html+=`</tr></tbody></table></div>`;
          return html;
        };

        const renderLedger=(y,m)=>{
          const prodTotals={}; let sum=0;
          const days=new Date(y,m,0).getDate();
          for(let d=1; d<=days; d++){
            const ds=ymd(y,m,d);
            (cust.schedule[ds]||[]).forEach(p=>{
              const unit=p.price||0, qty=p.qty||0, line=unit*qty;
              sum+=line;
              const key=p.name+'||'+unit;
              if(!prodTotals[key]) prodTotals[key]={name:p.name, unit:unit, qty:0, amount:0};
              prodTotals[key].qty += qty;
              prodTotals[key].amount += line;
            });
          }
          const vat=cust.vatSep?Math.round(sum*0.1):0, total=sum+vat;

          const rows = Object.values(prodTotals)
            .sort((a,b)=> a.name.localeCompare(b.name) || a.unit-b.unit)
            .map(r=>`<tr><td>${r.name}</td><td>${r.unit.toLocaleString()}원</td><td>${r.qty}</td><td>${r.amount.toLocaleString()}원</td></tr>`)
            .join('') || `<tr><td colspan="4" style="text-align:center;color:#888;">내역 없음</td></tr>`;

          return `
            <div class="invoice-ledger">
              <h5>내역</h5>
              <table>
                <thead><tr><th>제품명</th><th>단가(공급가)</th><th>수량</th><th>합계(공급가)</th></tr></thead>
                <tbody>${rows}</tbody>
                <tfoot>
                  <tr><td colspan="3">소계(공급가)</td><td>${sum.toLocaleString()}원</td></tr>
                  ${cust.vatSep?`<tr><td colspan="3">VAT(10%)</td><td>${vat.toLocaleString()}원</td></tr>`:''}
                  <tr><td colspan="3">총액</td><td><b>${total.toLocaleString()}원</b></td></tr>
                </tfoot>
              </table>
            </div>`;
        };

        let yOpts='', mOpts=''; 
        for(let y=yy-2;y<=yy+10;y++) yOpts+=`<option value="${y}" ${y===yy?'selected':''}>${y}년</option>`;
        for(let m=1;m<=12;m++) mOpts+=`<option value="${m}" ${m===mm?'selected':''}>${m}월</option>`;

        const section=document.createElement('div'); section.className='invoice-popup-cust';
        section.setAttribute('data-cust-index', String(idx));
        section.innerHTML = `
          <div class="invoice-popup-head">
            <div class="invoice-popup-title">${cust.name}</div>
            <div class="invoice-popup-meta">${cust.addr||''} &nbsp; ${cust.phone||''}</div>
          </div>
          <div class="invoice-popup-datebox">
            <label>연월 선택</label>
            <select id="${yearSelId}">${yOpts}</select>
            <select id="${monthSelId}">${mOpts}</select>
          </div>
          <div class="invoice-grid">
            <div id="${calWrapId}">${renderCal(yy,mm)}</div>
            <div id="${sumWrapId}">${renderLedger(yy,mm)}</div>
          </div>`;
        area.appendChild(section);

        setTimeout(()=>{
          const ySel=document.getElementById(yearSelId), mSel=document.getElementById(monthSelId);
          const calWrap=document.getElementById(calWrapId), sumWrap=document.getElementById(sumWrapId);
          const rerender=()=>{ const y=parseInt(ySel.value,10), m=parseInt(mSel.value,10); calWrap.innerHTML=renderCal(y,m); sumWrap.innerHTML=renderLedger(y,m); };
          ySel.onchange=rerender; mSel.onchange=rerender;
        },0);
      });

      document.getElementById('invoiceModalBg').classList.add('active');
    }
    function closeInvoicePopup(){ document.getElementById('invoiceModalBg').classList.remove('active'); }
    function getInvoiceCommonInfo(){
      return {
        company: (document.getElementById('invInfoCompany').value||'').trim(),
        person:  (document.getElementById('invInfoPerson').value||'').trim(),
        account: (document.getElementById('invInfoAccount').value||'').trim(),
        note:    (document.getElementById('invInfoNote').value||'').trim(),
        date:    (document.getElementById('invInfoDate').value||'').trim()
      };
    }
    function printInvoicePopup(){
      const info=getInvoiceCommonInfo();
      const container=document.createElement('div');
      container.innerHTML = document.getElementById('invoicePopupArea').innerHTML;

      container.querySelectorAll('.invoice-popup-cust').forEach(sec=>{
        const afterNode = sec.querySelector('.invoice-ledger') || sec.querySelector('.invoice-sum');
        const cardHtml = `<div class="info-card">
          <div class="line"><b>상호명</b> : ${info.company||'-'}</div>
          <div class="line"><b>담당자</b> : ${info.person||'-'}</div>
          <div class="line"><b>계좌번호</b> : ${info.account||'-'}</div>
          <div class="line"><b>작성일</b> : ${info.date||'-'}</div>
          ${info.note?`<div class="line"><b>비고</b> : ${info.note}</div>`:''}
        </div>`;
        if(afterNode) afterNode.insertAdjacentHTML('afterend', cardHtml);
        else sec.insertAdjacentHTML('beforeend', cardHtml);
      });

      const css=`<style>
        @page { size: A4 portrait; margin: 10mm; }
        body{font-family:Pretendard,Arial,sans-serif;color:#222;background:#fff;}
        .invoice-popup-cust{
          margin-bottom:20px;border:1px solid #e5eaf6;border-radius:14px;padding:12px 12px 10px;background:#fff;
          page-break-after:always;break-after:page;page-break-inside:avoid;break-inside:avoid;
        }
        .invoice-popup-head{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px;}
        .invoice-popup-title{font-size:18px;font-weight:900;}
        .invoice-popup-meta{display:none !important;}
        .invoice-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;}
        .invoice-cal{border:1px solid #e1e6f4;border-radius:12px;overflow:hidden;}
        .invoice-cal-title{background:#f0f5ff;padding:6px 8px;font-weight:800;font-size:13px;border-bottom:1px solid #e1e6f4;display:flex;justify-content:space-between;align-items:center;}
        .badge-paid{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;background:#e8f5e9;color:#2e7d32;border:1px solid #cde7d1;}
        .invoice-cal-table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;}
        .invoice-cal-table th{background:#f7f9ff;font-size:11.5px;padding:5px 0;border-bottom:1px solid #e1e6f4;}
        .invoice-cal-table td{height:88px;border:1px solid #e1e6f4;vertical-align:top;padding:0;position:relative;background:#fff;overflow:hidden;}
        .invoice-cal-table td .dnum{position:absolute;top:3px;right:5px;font-size:11px;color:#666;font-weight:800;}
        .invoice-cal-table td .dlines{position:absolute;left:6px;right:6px;top:20px;bottom:3px;overflow:auto;}
        .invoice-cal-table td .ditem{display:block;font-size:10.5px;color:#1b418a;margin-top:2px;word-break:keep-all;line-height:1.25;}
        .invoice-cal-table td.holiday{background:#fff6f5;color:#c33;}
        .invoice-ledger{ border:1px solid #e1e6f4; border-radius:12px; background:#fff; page-break-inside:avoid; break-inside:avoid; }
        .invoice-ledger h5{ margin:0; padding:8px 10px; background:#f0f5ff; border-bottom:1px solid #e1e6f4; font-size:13px; color:#1b418a; }
        .invoice-ledger table{ width:100%; border-collapse:collapse; }
        .invoice-ledger th,.invoice-ledger td{ border:1px solid #e1e6f4; padding:5px 6px; font-size:12.5px; text-align:right; }
        .invoice-ledger th:first-child,.invoice-ledger td:first-child{ text-align:left; }
        .invoice-ledger tfoot td{ font-weight:800; }
        .info-card{ border:1px solid #d9e4ff;background:#f7faff;border-radius:10px; padding:8px 10px;margin-top:6px;font-size:12px;line-height:1.35; page-break-inside:avoid; break-inside:avoid; }
        .info-card .line{font-size:12px;padding:1px 0;}
        @media print and (orientation:landscape){
          .invoice-grid{ grid-template-columns:1fr 1fr !important; gap:10px !important; }
          .invoice-cal-table td{ height:82px !important; }
        }
        @media print and (orientation:portrait){
          .invoice-grid{ grid-template-columns:1fr !important; gap:8px !important; }
        }
      </style>`;

      const win=window.open('','','width=1100,height=800');
      win.document.write('<html><head><title>청구서 인쇄</title>'+css+'</head><body>'+container.innerHTML+'</body></html>');
      win.document.close();
      setTimeout(()=>win.print(),350);
    }
    function hasScheduleInMonth(cust, y, m){
      const prefix = y+'-'+pad2(m)+'-';
      for(const d in (cust.schedule||{})){ if(d.startsWith(prefix) && cust.schedule[d] && cust.schedule[d].length) return true; }
      return false;
    }
    function filterInvoiceThisMonth(){
      const area=document.getElementById('invoicePopupArea');
      const sections=[...area.querySelectorAll('.invoice-popup-cust')];
      let hiddenCount=0;
      sections.forEach(sec=>{
        const idx=parseInt(sec.getAttribute('data-cust-index'),10);
        const cust=customers[idx];
        const ySel=sec.querySelector('select[id^="invoiceYear_"]');
        const mSel=sec.querySelector('select[id^="invoiceMonth_"]');
        const y=parseInt(ySel.value,10), m=parseInt(mSel.value,10);
        const show=hasScheduleInMonth(cust, y, m);
        sec.style.display = show ? '' : 'none';
        if(!show) hiddenCount++;
      });
      if(hiddenCount===sections.length) alert('이번 달 일정이 있는 고객이 없습니다.');
    }

    /* ===== 식단표 ===== */
    function getMonday(d){ const x=new Date(d); const day=x.getDay(); const diff = (day===0? -6 : 1) - day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
    function addDays(base, n){ const x=new Date(base); x.setDate(x.getDate()+n); return x; }

    let mealGroups = [ { name:'기본', warehouse:{ '국':'된장국', '밥':'찰보리밥' }, plan:{} } ];
    let weekStart = getMonday(new Date());
    let mealNotes = {}; // { 'YYYY-MM-DD'(주 시작일): '메모' }

    function weekKey(d){ return ymd(d.getFullYear(), d.getMonth()+1, d.getDate()); }
    function mmdd(d){ return pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
    function goMealToday(){ weekStart = getMonday(new Date()); renderMeal(); }

    function renderMeal(){
      const table=document.getElementById('mealTable'); table.innerHTML='';
      const startInput=document.getElementById('mealStartDate');
      startInput.value = ymd(weekStart.getFullYear(), weekStart.getMonth()+1, weekStart.getDate());
      startInput.onchange = ()=>{ const d=parseDateStr(startInput.value); weekStart=getMonday(d); renderMeal(); };

      const end=addDays(weekStart,6);
      document.getElementById('mealRangeText').textContent =
        `${ymd(weekStart.getFullYear(),weekStart.getMonth()+1,weekStart.getDate())} ~ ${ymd(end.getFullYear(), end.getMonth()+1, end.getDate())}`;

      let thead='<thead><tr><th class="col-group">구분</th>';
      for(let i=0;i<7;i++){ const d=addDays(weekStart,i); thead += `<th>${mmdd(d)}<br>${WEEK_LABELS[d.getDay()]}</th>`; }
      thead+='</tr></thead>';

      let tbody='<tbody>';
      mealGroups.forEach((g,gi)=>{
        tbody += `<tr data-gi="${gi}">
          <td class="col-group"><div class="group-head"><span class="group-name" title="이름 바꾸기" onclick="renameMealGroup(${gi})">${g.name}</span></div></td>`;
        for(let i=0;i<7;i++){
          const d=addDays(weekStart,i);
          const ds=ymd(d.getFullYear(), d.getMonth()+1, d.getDate());
          const cell=g.plan[ds]||[];
          const text = cell.map(it=> it.cat && it.cat!=='메뉴' ? `${it.cat}: ${it.menu}` : `${it.menu}`).join('\n');
          tbody += `<td onclick="openPicker(event, ${gi}, '${ds}')"><div class="cell-text">${text||''}</div></td>`;
        }
        tbody+='</tr>';
      });
      tbody+='</tbody>';

      table.innerHTML = thead + tbody;

      const noteInput=document.getElementById('mealNoteInput');
      const key=weekKey(weekStart);
      noteInput.value = mealNotes[key] || '';
      noteInput.oninput = ()=>{ mealNotes[key] = noteInput.value; touchSave(); };
    }
    function shiftWeek(delta){ weekStart = addDays(weekStart, delta); renderMeal(); }
    function addMealGroup(){ const name = prompt('새 구분 이름?', '기본'); if(!name) return; mealGroups.push({ name, warehouse:{}, plan:{} }); renderMeal(); renderWarehouseColumns(); }
    function renameMealGroup(i){ const nv = prompt('구분 이름 변경', mealGroups[i].name); if(!nv) return; mealGroups[i].name = nv.trim(); renderMeal(); renderWarehouseColumns(); }

    function renderWarehouseColumns(){
      const wrap=document.getElementById('warehouseColumns'); wrap.innerHTML='';
      mealGroups.forEach((g,gi)=>{
        const col=document.createElement('div'); col.className='wh-col';
        let rowsHtml='';
        Object.keys(g.warehouse).forEach(cat=>{
          rowsHtml += `
            <div class="wh-row">
              <div class="wh-head"><b>${cat}</b><button class="wh-del" onclick="whDeleteCategory(${gi}, '${cat.replace(/'/g,"\\'")}')">삭제</button></div>
              <div class="wh-body"><input type="text" value="${g.warehouse[cat]||''}" placeholder="${cat} 기본 메뉴 입력" oninput="whUpdateMenu(${gi}, '${cat.replace(/'/g,"\\'")}', this.value)" /></div>
            </div>`;
        });
        col.innerHTML = `
          <div class="wh-col-head"><span class="name">${g.name}</span><div class="tools"></div></div>
          <div>${rowsHtml || '<div style="color:#888;font-size:13px;">카테고리를 추가하세요.</div>'}</div>
          <div class="wh-add">
            <input type="text" id="whAddInput_${gi}" placeholder="[카테고리] 추가 (Enter)" />
            <button onclick="whAddCategory(${gi})">+</button>
          </div>`;
        wrap.appendChild(col);
        const input=document.getElementById(`whAddInput_${gi}`); input.onkeydown=(e)=>{ if(e.key==='Enter'){ whAddCategory(gi); } };
      });
    }
    function whAddCategory(gi){ const input=document.getElementById(`whAddInput_${gi}`); if(!input) return; const v=(input.value||'').trim(); if(!v) return;
      const g=mealGroups[gi]; if(g.warehouse[v]){ alert('이미 있는 카테고리입니다.'); return; } g.warehouse[v]=''; input.value=''; renderWarehouseColumns(); }
    function whDeleteCategory(gi, cat){ const g=mealGroups[gi]; delete g.warehouse[cat]; renderWarehouseColumns(); }
    function whUpdateMenu(gi, cat, val){ const g=mealGroups[gi]; g.warehouse[cat]=val; }

    let pickerEl=null;
    function openPicker(ev, gi, ds){
      closePicker();
      const g=mealGroups[gi];
      const cats=Object.keys(g.warehouse);

      pickerEl=document.createElement('div'); pickerEl.className='picker';
      const pickList = cats.map(cat=>{
        const val=g.warehouse[cat]||'';
        return `<div class="pick-item" data-cat="${cat.replace(/"/g,'&quot;')}" title="클릭하면 즉시 적용">${cat} : <b style="color:#1b418a">${val||'-'}</b></div>`;
      }).join('') || '<div style="color:#888;font-size:13px;">카테고리가 없습니다.</div>';

      pickerEl.innerHTML = `
        <div><h5>창고에서 선택 (클릭 즉시 적용)</h5><div class="pick-list">${pickList}</div></div>
        <div class="quick"><input id="pickerQuick" type="text" placeholder="빠른 입력: 예) 국: 된장국  (Enter 저장)" /><button id="pickerSaveBtn">저장</button></div>
        <button class="clear-btn" id="pickerClearBtn">이 칸 비우기</button>`;
      document.body.appendChild(pickerEl);
      const r=ev.target.getBoundingClientRect();
      pickerEl.style.left=(Math.min(r.left, window.innerWidth- pickerEl.offsetWidth - 12)+window.scrollX)+'px';
      pickerEl.style.top=(r.bottom+window.scrollY+6)+'px';

      pickerEl.querySelectorAll('.pick-item').forEach(el=>{ el.addEventListener('click', ()=>{ const cat = el.getAttribute('data-cat'); applyWarehousePick(gi, ds, cat); closePicker(); }); });
      const quick=document.getElementById('pickerQuick'); const saveBtn=document.getElementById('pickerSaveBtn');
      const save = ()=> { savePickerQuick(gi, ds); closePicker(); };
      quick.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); save(); } }); saveBtn.addEventListener('click', save);
      document.getElementById('pickerClearBtn').onclick = ()=>{ clearMealCell(gi, ds); closePicker(); };
    }
    function closePicker(){ if(pickerEl){ pickerEl.remove(); pickerEl=null; } }
    window.addEventListener('click',(e)=>{ if(pickerEl && !pickerEl.contains(e.target) && !e.target.closest('.picker')){ if(!e.target.closest('td')) closePicker(); } });

    function parseFreeLines(text){
      const items=[]; (text||'').split('\n').map(s=>s.trim()).filter(s=>s).forEach(line=>{
        const idx=line.indexOf(':'); if(idx>-1){ const cat=line.slice(0,idx).trim(), menu=line.slice(idx+1).trim(); items.push({cat:cat||'메뉴', menu}); }
        else{ items.push({cat:'메뉴', menu:line}); }
      }); return items;
    }
    function applyWarehousePick(gi, ds, cat){
      const g=mealGroups[gi]; const menu=g.warehouse[cat]||''; if(!menu){ alert('이 카테고리에 저장된 메뉴가 없습니다.'); return; }
      let arr=g.plan[ds]||[]; const ix = arr.findIndex(x=>x.cat===cat); if(ix>=0) arr[ix].menu = menu; else arr.push({cat, menu});
      g.plan[ds]=arr; renderMeal();
    }
    function savePickerQuick(gi, ds){
      const g=mealGroups[gi]; const q=document.getElementById('pickerQuick').value.trim(); if(!q){ return; }
      const items = parseFreeLines(q); if(!items.length){ return; }
      let arr = g.plan[ds] || [];
      items.forEach(it=>{
        if(it.cat){ const ix = arr.findIndex(x=>x.cat===it.cat); if(ix>=0) arr[ix].menu = it.menu; else arr.push({cat:it.cat, menu:it.menu}); g.warehouse[it.cat] = it.menu; }
        else{ arr.push({cat:'메뉴', menu:it.menu}); }
      });
      g.plan[ds] = arr; renderMeal(); renderWarehouseColumns();
    }
    function clearMealCell(gi, ds){ const g=mealGroups[gi]; delete g.plan[ds]; renderMeal(); }

    function printMeal(){
      const tableHTML=document.getElementById('mealTable').outerHTML;
      const noteText = (document.getElementById('mealNoteInput').value||'').trim();
      const css=`<style>
        @page { size: A4 landscape; margin: 8mm; }
        body{font-family:Pretendard,Arial,sans-serif;color:#222;}
        table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;}
        th{background:#edf3ff;color:#244a9a;padding:10px 6px;border:1px solid #e2e7f2;font-weight:900;text-align:center;font-size:15px;}
        td{border:1px solid #e2e7f2;min-height:64px;height:72px;vertical-align:middle;padding:8px;font-size:18px;text-align:center;}
        .col-group{width:180px;background:#fff7f7;font-weight:900;text-align:center;}
        .cell-text{white-space:pre-line;line-height:1.35;color:#183b86;font-size:18px;font-weight:900;text-align:center;}
        .note{margin-top:8px;font-size:13.5px;color:#333;text-align:center;}
      </style>`;
      const noteHTML = noteText ? `<div class="note">메모: ${noteText}</div>` : '';
      const win=window.open('','','width=1200,height=800');
      win.document.write('<html><head><title>주간 식단표</title>'+css+'</head><body>'+tableHTML+noteHTML+'</body></html>');
      win.document.close();
      setTimeout(()=>win.print(),350);
    }

    /* ===== 초기 렌더 ===== */
    window.addEventListener('DOMContentLoaded', ()=>{
      fillYearMonth(); renderCalendar(); renderHolidaysList();
      renderCustomerTable(); renderProductTable(); fillProdOptions();
      selectedDeliveryDate=getTomorrowStr(); renderDeliveryPage();
      renderMeal(); renderWarehouseColumns();
    });
  </script>

  <!-- html2canvas for JPG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- ===== 저장/복원 & 자동 백업 ===== -->
  <script>
  const STATE_VERSION = 1;
  const LS_KEY = 'lunchapp_state_v' + STATE_VERSION;
  const LS_BACKUP_WANTED_KEY = 'lunchapp_backup_wanted';
  let backupFileHandle = null;
  let lastWarnMs = 0;

  function getAppState() {
    return { v:STATE_VERSION, customers, productList, holidays, mealGroups, mealNotes };
  }
  function setAppState(state) {
    customers   = state.customers   || [];
    productList = state.productList || [];
    holidays    = state.holidays    || {};
    mealGroups  = state.mealGroups  || [];
    mealNotes   = state.mealNotes   || {};
  }
  function rehydrateUI() {
    fillYearMonth(); renderCalendar(); renderHolidaysList();
    renderCustomerTable(); renderProductTable(); fillProdOptions();
    renderDeliveryPage(); renderMeal(); renderWarehouseColumns();
  }

  let _saveTimer = null;
  function saveLocalImmediate() {
    try { localStorage.setItem(LS_KEY, JSON.stringify(getAppState())); }
    catch(e){ console.warn('로컬 저장 실패:', e); }
  }
  function shouldWarnNoBackup(){
    if (backupFileHandle) return false;
    if (!('showSaveFilePicker' in window)) return false;
    const now=Date.now(); if (now - lastWarnMs < 15000) return false; lastWarnMs = now; return true;
  }
  async function writeBackupToFile(){
    if(!backupFileHandle) return;
    try{
      const writable = await backupFileHandle.createWritable();
      await writable.write(JSON.stringify(getAppState(), null, 2));
      await writable.close();
    }catch(e){
      console.warn('자동 백업 실패:', e);
      showToast('자동 백업 실패: 권한을 다시 지정해주세요.');
    }
  }
  function touchSave(){
    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(async ()=>{
      saveLocalImmediate();
      if (backupFileHandle) { await writeBackupToFile(); }
      else if (shouldWarnNoBackup()) { showToast('백업 파일을 먼저 지정하세요. 상단 “백업 파일 지정” 버튼!'); }
    }, 300);
  }
  function loadLocal(){
    try{
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const parsed=JSON.parse(raw);
      if(!parsed || parsed.v!==STATE_VERSION) return false;
      setAppState(parsed);
      return true;
    }catch(e){ console.warn('로컬 로드 실패:', e); return false; }
  }

  async function chooseBackupFile(){
    if (!('showSaveFilePicker' in window)) {
      alert('자동 백업은 이 브라우저에서 지원되지 않습니다. Chrome/Edge 최신 버전을 권장합니다.');
      return;
    }
    try{
      const now=new Date();
      const stamp=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      backupFileHandle = await window.showSaveFilePicker({
        suggestedName: `도시락_백업_${stamp}.json`,
        types: [{ description:'JSON', accept:{ 'application/json':['.json'] } }]
      });
      await writeBackupToFile();
      localStorage.setItem(LS_BACKUP_WANTED_KEY,'1');
      updateBackupUI(true);
      showToast('자동 백업 파일이 설정되었습니다.');
      document.getElementById('backupReconnect')?.classList.remove('show');
    }catch(e){
      if (e && e.name === 'AbortError') return;
      alert('백업 파일 지정 실패: ' + (e?.message||e));
    }
  }
  function updateBackupUI(connected){
    const btn=document.getElementById('btnBackupAssign');
    if(!btn) return;
    if(connected){
      btn.textContent='백업 파일 연결됨';
      btn.style.background='#d8f5d0'; btn.style.color='#1b5e20';
    }else{
      btn.textContent='백업 파일 지정';
      btn.style.background='#fffde7'; btn.style.color='#2176ff';
    }
  }
  function wireBackupButtons(){
    const assignBtn=document.getElementById('btnBackupAssign');
    if(assignBtn) assignBtn.onclick = chooseBackupFile;
  }

  // JPG 저장(청구서 섹션별)
  async function saveInvoiceAsJPG(){
    const area = document.getElementById('invoicePopupArea');
    const sections = area.querySelectorAll('.invoice-popup-cust');
    if(!sections.length){ alert('저장할 내용이 없습니다.'); return; }
    for(let i=0;i<sections.length;i++){
      const sec=sections[i];
      const canvas = await html2canvas(sec, {scale:2, backgroundColor:'#ffffff'});
      const dataURL = canvas.toDataURL('image/jpeg', 0.92);
      const a=document.createElement('a');
      const name = (sec.querySelector('.invoice-popup-title')?.textContent||'고객') + `_${i+1}`;
      a.href=dataURL; a.download = `${name}.jpg`;
      document.body.appendChild(a); a.click(); a.remove();
      await new Promise(r=>setTimeout(r, 150));
    }
    showToast('JPG 저장 완료');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const restored=loadLocal();
    if(restored) rehydrateUI();
    wireBackupButtons();
    updateBackupUI(false);

    if(localStorage.getItem(LS_BACKUP_WANTED_KEY)==='1' && ('showSaveFilePicker' in window)){
      const banner = document.getElementById('backupReconnect');
      const btn = document.getElementById('backupReconnectBtn');
      const closeBtn = document.getElementById('backupReconnectClose');

      if(banner && btn){
        banner.classList.add('show');
        btn.onclick = async ()=>{
          await chooseBackupFile();
          banner.classList.remove('show');
        };
      }
      if(closeBtn){ closeBtn.onclick = ()=> banner.classList.remove('show'); }
    }
  });

  /* 자동 저장 디바운스: 주요 변경 함수 래핑 */
  const _saveModalSchedule_orig = saveModalSchedule; saveModalSchedule = function(){ _saveModalSchedule_orig(); touchSave(); };
  const _addProductRow = addProductRow; addProductRow = function(){ _addProductRow(); touchSave(); };
  const _delProductRow = delProductRow; delProductRow = function(i){ _delProductRow(i); touchSave(); };
  const _addProdItem = addProdItem; addProdItem = function(i){ _addProdItem(i); touchSave(); };
  const _delProdItem = delProdItem; delProdItem = function(i,j){ _delProdItem(i,j); touchSave(); };
  const _handleCalendarDateClick = handleCalendarDateClick; handleCalendarDateClick = function(dateStr){ _handleCalendarDateClick(dateStr); touchSave(); };
  const _togglePay = togglePay; togglePay = function(){ _togglePay(); touchSave(); };
  const _toggleVat = toggleVat; toggleVat = function(){ _toggleVat(); touchSave(); };
  const _changeProdToDate = changeProdToDate; changeProdToDate = function(type, useWeekdays){ _changeProdToDate(type, useWeekdays); touchSave(); };
  const _removeProdFromDate = removeProdFromDate; removeProdFromDate = function(type){ _removeProdFromDate(type); touchSave(); };
  const _applyWarehousePick = applyWarehousePick; applyWarehousePick = function(gi, ds, cat){ _applyWarehousePick(gi, ds, cat); touchSave(); };
  const _savePickerQuick = savePickerQuick; savePickerQuick = function(gi, ds){ _savePickerQuick(gi, ds); touchSave(); };
  const _clearMealCell = clearMealCell; clearMealCell = function(gi, ds){ _clearMealCell(gi, ds); touchSave(); };
  const _addMealGroup = addMealGroup; addMealGroup = function(){ _addMealGroup(); touchSave(); };
  const _renameMealGroup = renameMealGroup; renameMealGroup = function(i){ _renameMealGroup(i); touchSave(); };
  const _whAddCategory = whAddCategory; whAddCategory = function(gi){ _whAddCategory(gi); touchSave(); };
  const _whDeleteCategory = whDeleteCategory; whDeleteCategory = function(gi, cat){ _whDeleteCategory(gi, cat); touchSave(); };
  const _whUpdateMenu = whUpdateMenu; whUpdateMenu = function(gi, cat, val){ _whUpdateMenu(gi, cat, val); touchSave(); };
  const _applyHolidayRetroactively = applyHolidayRetroactively; applyHolidayRetroactively = function(ds){ _applyHolidayRetroactively(ds); touchSave(); };
  const _addCustomer = addCustomer; addCustomer = function(){ _addCustomer(); touchSave(); };

  window.addEventListener('beforeunload', saveLocalImmediate);
  </script>
</body>
</html>
